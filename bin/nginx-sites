#!/usr/bin/env python

import sys
import os

config = {
	'root': '/var/www/',
	'confdir': '/etc/nginx/conf/sites/',
}

config['tmpl-php'] = """
server {
	listen 80;
	server_name %(name)s.local;

	root %(path)s;
	index index.php index.html;

	location / {
		if (!-e $request_filename) {
			rewrite ^/(.*)$ /index.php?$1 last;
		}
	}

	location ~ \.php$ {
		try_files $uri =404;
		fastcgi_pass   127.0.0.1:9000;
		fastcgi_index  index.php;
		fastcgi_param  SCRIPT_FILENAME  %(path)s$fastcgi_script_name;
		include        fastcgi_params;
	}
}
"""

config['tmpl-python'] = """
server {
	listen 80;
	server_name %(name)s.local;
	root /var/www/%(name)s;
	location /public/ {
		alias /var/www/%(name)s/public/;
		# include /etc/nginx/gzip.conf;
		expires 30d;
		access_log off;
	}
	location / {
		include uwsgi_params;
		uwsgi_pass unix:/var/www/run/%(name)s.sock;
	}
}
"""

config['apache-tmpl-php'] = """
<VirtualHost *:80>
    ServerName %(name)s.test

    DocumentRoot "/var/www/%(name)s/"

    <Directory "/var/www/%(name)s/">
		  Options FollowSymLinks MultiViews Includes
		  AllowOverride All
        Order allow,deny
        Allow from all
    </Directory>

    ErrorLog /var/log/apache2/%(name)s_error.log
    LogLevel warn
    CustomLog /var/log/apache2/%(name)s_access.log combined
</VirtualHost>
"""



class Commands:
	def __init__(self, config):
		self.__dict__.update(config)

	def add(self, name, tmpl):
		with open(self.confdir + name, 'w') as fp:
			path = self.root + name
			fp.write(getattr(self, "tmpl-" + tmpl) % locals())

	def remove(self, name):
		os.remove(self.confdir + name)

	def ls(self):
		walker = os.walk(self.confdir)
		_, _, sites = next(walker)
		print("\n".join(sites))

	def copy(self, old, new):
		pass

	def edit(self, name):
		print(self.confdir + name)


def main():
	cmdstr = 'ls' if len(sys.argv) == 1 else sys.argv[1]
	opts = sys.argv[2:]
	cmd = getattr(Commands(config), cmdstr)
	if cmd is not None:
		cmd(*opts)
	else:
		sys.exit(1)

if __name__ == '__main__':
	main()
